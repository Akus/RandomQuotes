name: ASP.NET Core CI
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 2.2.108
    - name: Get Git Version
      uses: docker://gittools/gitversion:5.0.2-beta1-27-linux-centos-7-netcoreapp2.2
      with:
        args: /github/workspace /nofetch /exec /bin/sh /execargs "-c \"echo $GitVersion_FullSemVer > /github/workspace/version.txt\""
    - name: Extract Octopus Tools
      run: |
        mkdir /opt/octo
        cd /opt/octo
        wget -O /opt/octo/octopus.zip https://download.octopusdeploy.com/octopus-tools/6.12.0/OctopusTools.6.12.0.portable.zip
        unzip /opt/octo/octopus.zip
        chmod +x /opt/octo/Octo
    - name: Build with dotnet
      run: dotnet build --configuration Release
    - name: Publish with dotnet
      run: dotnet publish -o site --configuration Release
    - name: Pack DotNET App
      run: |
        cd /home/runner/work/RandomQuotes/RandomQuotes/RandomQuotes/site
        zip -r /home/runner/work/RandomQuotes/RandomQuotes/site.zip * 
    - name: Pack Beanstalk App
      run: >-
        /opt/octo/Octo pack .
        --outFolder /home/runner/work/RandomQuotes/RandomQuotes
        --include /home/runner/work/RandomQuotes/RandomQuotes/site.zip
        --include /home/runner/work/RandomQuotes/RandomQuotes/aws-windows-deployment-manifest.json
        --id RandomQuotes
        --version $(cat /home/runner/work/RandomQuotes/RandomQuotes/version.txt)
        --format zip
    - name: Push to Octopus
      run: >-
        /opt/octo/Octo push
        --server ${{ secrets.OctopusUrl }}
        --apiKey ${{ secrets.OctopusApiKey }}
        --package /home/runner/work/RandomQuotes/RandomQuotes/RandomQuotes.$(cat /home/runner/work/RandomQuotes/RandomQuotes/version.txt).zip
        --overwrite-mode IgnoreIfExists